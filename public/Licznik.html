<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Edytor plików</title>

<style>
  body { font-family: sans-serif; margin:20px; }
  #editor { height:400px; border:1px solid #ccc; }
  iframe { width:100%; height:300px; border:1px solid #ccc; margin-top:10px; }
  select, input, button { margin:5px 5px 5px 0; }
</style>

<!-- Monaco loader -->
<script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
</head>

<body>

<h2>Pliki</h2>

<select id="fileSelect"></select>
<button id="loadBtn">Załaduj</button>
<button id="saveBtn">Zapisz</button>
<button onclick="formatCode()">Formatuj</button>
<button onclick="preview()">Podgląd</button>

<h3>Nowy plik</h3>

<select id="folderSelect">
  <option value="">(główny)</option>
</select>

<input type="text" id="newFileName" placeholder="np. index.html">
<button id="createBtn">Stwórz plik</button>

<div id="editor"></div>

<iframe id="previewFrame"></iframe>

<script>
let editor;
let currentFile = "";

const fileSelect = document.getElementById("fileSelect");
const previewFrame = document.getElementById("previewFrame");

require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@0.45.0/min/vs' }});

require(["vs/editor/editor.main"], function () {

  editor = monaco.editor.create(document.getElementById("editor"), {
    value: "",
    language: "html",
    theme: "vs-dark",
    automaticLayout: true
  });

  refreshFiles();
  refreshFolders();
});

function setLanguage(name){
  if(name.endsWith(".html"))
    monaco.editor.setModelLanguage(editor.getModel(),"html");
  else if(name.endsWith(".css"))
    monaco.editor.setModelLanguage(editor.getModel(),"css");
  else if(name.endsWith(".js"))
    monaco.editor.setModelLanguage(editor.getModel(),"javascript");
}

async function refreshFiles(){
  const res = await fetch("/api/files");
  const files = await res.json();

  fileSelect.innerHTML = "";

  files.forEach(f=>{
    const opt = document.createElement("option");
    opt.value = f;
    opt.textContent = f;
    fileSelect.appendChild(opt);
  });

  if(files.length){
    currentFile = files[0];
    loadFile();
  }
}

async function loadFile(){
  currentFile = fileSelect.value;

  const res = await fetch(`/api/getfile?file=${currentFile}`);
  const txt = await res.text();

  editor.setValue(txt);
  setLanguage(currentFile);
}

async function refreshFolders(){
  const res = await fetch("/api/folders");
  const folders = await res.json();

  const folderSelect = document.getElementById("folderSelect");

  folderSelect.innerHTML = '<option value="">(główny)</option>';

  folders.forEach(f=>{
    const opt = document.createElement("option");
    opt.value = f;
    opt.textContent = f;
    folderSelect.appendChild(opt);
  });
}

document.getElementById("loadBtn").onclick = loadFile;

document.getElementById("saveBtn").onclick = async ()=>{
  const content = editor.getValue();

  await fetch("/api/savefile",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      file: currentFile,
      content
    })
  });

  alert("Zapisano");
};

document.getElementById("createBtn").onclick = async ()=>{
  const name = document.getElementById("newFileName").value.trim();
  const folder = document.getElementById("folderSelect").value;

  if(!name) return alert("Podaj nazwę");

  await fetch("/api/createfile",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      file: name,
      folder
    })
  });

  alert("Utworzono");

  refreshFiles();
  refreshFolders();
};

function formatCode(){
  editor.getAction("editor.action.formatDocument").run();
}

function preview(){
  const html = editor.getValue();

  const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;

  doc.open();
  doc.write(html);
  doc.close();
}
</script>

</body>
</html>
